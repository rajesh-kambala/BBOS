<?xml version="1.0" encoding="utf-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2008/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Body>
    <ReportItems>
      <Tablix Name="Tablix1">
        <TablixCorner>
          <TablixCornerRows>
            <TablixCornerRow>
              <TablixCornerCell>
                <CellContents>
                  <Textbox Name="Textbox5">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value />
                            <Style>
                              <FontFamily>Calibri</FontFamily>
                              <FontSize>12pt</FontSize>
                              <TextDecoration>Underline</TextDecoration>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style>
                          <TextAlign>Center</TextAlign>
                        </Style>
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>Textbox5</rd:DefaultName>
                    <Style>
                      <Border>
                        <Style>Solid</Style>
                      </Border>
                      <TopBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </TopBorder>
                      <BottomBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </BottomBorder>
                      <LeftBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </LeftBorder>
                      <RightBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </RightBorder>
                      <BackgroundColor>Gainsboro</BackgroundColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                </CellContents>
              </TablixCornerCell>
            </TablixCornerRow>
          </TablixCornerRows>
        </TablixCorner>
        <TablixBody>
          <TablixColumns>
            <TablixColumn>
              <Width>1.75in</Width>
            </TablixColumn>
          </TablixColumns>
          <TablixRows>
            <TablixRow>
              <Height>0.22396in</Height>
              <TablixCells>
                <TablixCell>
                  <CellContents>
                    <Textbox Name="ColValue">
                      <CanGrow>true</CanGrow>
                      <KeepTogether>true</KeepTogether>
                      <Paragraphs>
                        <Paragraph>
                          <TextRuns>
                            <TextRun>
                              <Value>=Fields!ColValue.Value</Value>
                              <Style>
                                <FontFamily>Calibri</FontFamily>
                              </Style>
                            </TextRun>
                          </TextRuns>
                          <Style>
                            <TextAlign>Left</TextAlign>
                          </Style>
                        </Paragraph>
                      </Paragraphs>
                      <rd:DefaultName>ColValue</rd:DefaultName>
                      <Style>
                        <Border>
                          <Style>Solid</Style>
                        </Border>
                        <TopBorder>
                          <Color>Black</Color>
                          <Style>Solid</Style>
                          <Width>1pt</Width>
                        </TopBorder>
                        <BottomBorder>
                          <Color>Black</Color>
                          <Style>Solid</Style>
                          <Width>1pt</Width>
                        </BottomBorder>
                        <LeftBorder>
                          <Color>Black</Color>
                          <Style>Solid</Style>
                          <Width>1pt</Width>
                        </LeftBorder>
                        <RightBorder>
                          <Color>Black</Color>
                          <Style>Solid</Style>
                          <Width>1pt</Width>
                        </RightBorder>
                        <PaddingLeft>2pt</PaddingLeft>
                        <PaddingRight>2pt</PaddingRight>
                        <PaddingTop>2pt</PaddingTop>
                        <PaddingBottom>2pt</PaddingBottom>
                      </Style>
                    </Textbox>
                  </CellContents>
                </TablixCell>
              </TablixCells>
            </TablixRow>
          </TablixRows>
        </TablixBody>
        <TablixColumnHierarchy>
          <TablixMembers>
            <TablixMember>
              <Group Name="DisplayName">
                <GroupExpressions>
                  <GroupExpression>=Fields!DisplayName.Value</GroupExpression>
                </GroupExpressions>
              </Group>
              <TablixHeader>
                <Size>0.17188in</Size>
                <CellContents>
                  <Textbox Name="DisplayName">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value>=Fields!DisplayName.Value</Value>
                            <Style>
                              <FontFamily>Calibri</FontFamily>
                              <FontSize>12pt</FontSize>
                              <FontWeight>Bold</FontWeight>
                              <TextDecoration>Underline</TextDecoration>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style>
                          <TextAlign>Center</TextAlign>
                        </Style>
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>DisplayName</rd:DefaultName>
                    <Style>
                      <Border>
                        <Style>Solid</Style>
                      </Border>
                      <BackgroundColor>Gainsboro</BackgroundColor>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                </CellContents>
              </TablixHeader>
            </TablixMember>
          </TablixMembers>
        </TablixColumnHierarchy>
        <TablixRowHierarchy>
          <TablixMembers>
            <TablixMember>
              <Group Name="BBID">
                <GroupExpressions>
                  <GroupExpression>=Fields!BBID.Value</GroupExpression>
                </GroupExpressions>
              </Group>
              <SortExpressions>
                <SortExpression>
                  <Value>=Fields!BBID.Value</Value>
                </SortExpression>
              </SortExpressions>
              <TablixHeader>
                <Size>0.66667in</Size>
                <CellContents>
                  <Textbox Name="BBID">
                    <CanGrow>true</CanGrow>
                    <KeepTogether>true</KeepTogether>
                    <Paragraphs>
                      <Paragraph>
                        <TextRuns>
                          <TextRun>
                            <Value>=Fields!BBID.Value</Value>
                            <Style>
                              <FontFamily>Calibri</FontFamily>
                            </Style>
                          </TextRun>
                        </TextRuns>
                        <Style>
                          <TextAlign>Center</TextAlign>
                        </Style>
                      </Paragraph>
                    </Paragraphs>
                    <rd:DefaultName>BBID</rd:DefaultName>
                    <Style>
                      <Border>
                        <Style>Solid</Style>
                      </Border>
                      <TopBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </TopBorder>
                      <BottomBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </BottomBorder>
                      <LeftBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </LeftBorder>
                      <RightBorder>
                        <Color>Black</Color>
                        <Style>Solid</Style>
                        <Width>1pt</Width>
                      </RightBorder>
                      <PaddingLeft>2pt</PaddingLeft>
                      <PaddingRight>2pt</PaddingRight>
                      <PaddingTop>2pt</PaddingTop>
                      <PaddingBottom>2pt</PaddingBottom>
                    </Style>
                  </Textbox>
                </CellContents>
              </TablixHeader>
            </TablixMember>
          </TablixMembers>
        </TablixRowHierarchy>
        <DataSetName>DataSet1</DataSetName>
        <Height>0.39584in</Height>
        <Width>2.41667in</Width>
        <Style>
          <Border>
            <Style>None</Style>
          </Border>
        </Style>
      </Tablix>
    </ReportItems>
    <Height>0.39584in</Height>
    <Style />
  </Body>
  <Width>2.41667in</Width>
  <Page>
    <LeftMargin>1in</LeftMargin>
    <RightMargin>1in</RightMargin>
    <TopMargin>1in</TopMargin>
    <BottomMargin>1in</BottomMargin>
    <Style />
  </Page>
  <AutoRefresh>0</AutoRefresh>
  <DataSources>
    <DataSource Name="BBS">
      <DataSourceReference>BBS</DataSourceReference>
      <rd:SecurityType>None</rd:SecurityType>
      <rd:DataSourceID>288f6554-844d-4429-976b-06ef8f844881</rd:DataSourceID>
    </DataSource>
  </DataSources>
  <DataSets>
    <DataSet Name="DataSet1">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <QueryParameters>
          <QueryParameter Name="@Ind">
            <Value>=Parameters!Ind.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@Territory">
            <Value>=Parameters!Territory.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@MemType">
            <Value>=Parameters!MemType.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@State">
            <Value>=Parameters!State.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@ChosenFactors">
            <Value>=Parameters!ChosenFactors.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@TileCount">
            <Value>=Parameters!TileCount.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@StartDate">
            <Value>=Parameters!StartDate.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@EndDate">
            <Value>=Parameters!EndDate.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@RequireFactors">
            <Value>=Parameters!RequireFactors.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@MustHaves">
            <Value>=Parameters!MustHaves.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <CommandText>
          DECLARE @Population TABLE
          (HQID INT)

          DECLARE @Temp TABLE
          (BBID INT, Factor NVARCHAR(100),Val INT, Tile INT, UNIQUE CLUSTERED (BBID, Factor))

          DECLARE @TES TABLE
          (CompanyID INT, TESRole NVARCHAR(10), Cnt INT)

          CREATE TABLE #DisplayValues
          (nxd INT IDENTITY, BBID INT, ColName NVARCHAR(1000), ColValue NVARCHAR(MAX))

          INSERT INTO @Population (HQID)
          SELECT comp_CompanyID
          FROM Company WITH (NOLOCK)
          INNER JOIN vPRLocation WITH (NOLOCK) ON prci_CityID = comp_PRListingCityID
          WHERE comp_PRType = 'H'
          AND comp_PRIndustryType IN (@Ind)
          AND LEFT(prci_SalesTerritory,2) IN (@Territory)
          AND isnull(dbo.ufn_GetPrimaryService(comp_CompanyID), 'None') IN (@MemType)
          AND comp_PRListingStatus IN ('L','H','LUV')
          AND prst_StateID IN (@State)

          -- Personnel Count

          IF 'Person' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors) BEGIN
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Person'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(peli_PersonLinkID)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN Person_Link WITH (NOLOCK) ON peli_Companyid = comp_CompanyID
          AND peli_PRStatus = 1
          GROUP BY HQID)TableA
          END

          IF 'Connections' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          -- CL Count
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Connections'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(DISTINCT prcr_RightCompanyID)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRCompanyRelationship WITH (NOLOCK) ON comp_CompanyID = prcr_LeftCompanyID
          AND prcr_Active = 'Y'
          AND prcr_Type IN ('09','10','11','12','13','14','15','16')
          GROUP BY HQID)TableA
          END
          -- Cross CL Count

          IF 'Xconnections' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Xconnections'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(DISTINCT prcr_LeftCompanyID)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRCompanyRelationship WITH (NOLOCK) ON comp_CompanyID = prcr_RightCompanyID
          AND prcr_Active = 'Y'
          AND prcr_Type IN ('09','10','11','12','13','14','15','16')
          GROUP BY HQID)TableA

          END
          -- CWE
          IF 'CWE' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN

          INSERT INTO @Temp
          SELECT
          HQID
          , 'CWE'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = CONVERT(INT,LEFT(dbo.GetLowerAlpha(prcw_Name), LEN(dbo.GetLowerAlpha(prcw_Name))-1))
          FROM @Population
          INNER JOIN PRRating v ON prra_CompanyId = HQID
          AND prra_Current = 'Y'
          INNER JOIN PRCreditWorthRating ON prra_CreditWorthId = prcw_CreditWorthRatingId
          AND prcw_IsNumeral IS NULL)TableA
          END
          -- Non Lumber Volume

          IF 'Volume' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Volume'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = CONVERT(INT,dbo.GetLowerAlpha(Capt_US))
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = HQID
          AND comp_PRIndustryType != 'L'
          INNER JOIN PRCompanyProfile WITH (NOLOCK) ON prcp_CompanyId = HQID
          INNER JOIN Custom_Captions WITH (NOLOCK) ON prcp_Volume = Capt_Code
          AND Capt_Family = 'prcp_Volume' )TableA

          END
          --Location Count
          IF 'Locations' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Locations'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(comp_CompanyID)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          AND comp_PRListingStatus IN ('l','h','luv')
          GROUP BY HQID)TableA
          END

          IF 'CSItem' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --CS Item Count
          INSERT INTO @Temp
          SELECT
          HQID
          , 'CSItem'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(prcs_CreditSheetId)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRCreditSheet WITH (NOLOCK) ON prcs_CompanyId = comp_CompanyID
          AND prcs_Status = 'P'
          AND prcs_PublishableDate BETWEEN @StartDate AND @EndDate
          GROUP BY HQID)TableA
          END

          IF 'PRTR_On' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Trade Report On
          INSERT INTO @Temp
          SELECT
          HQID
          , 'PRTR_On'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(prtr_TradeReportId)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRTradeReport WITH (NOLOCK) ON prtr_SubjectId = comp_CompanyID
            AND prtr_Date BETWEEN @StartDate AND @EndDate
            AND prtr_Duplicate IS NULL
          INNER JOIN Company C1 WITH (NOLOCK) ON C1.Comp_CompanyId = prtr_SubjectId AND C1.comp_PRIgnoreTES IS NULL
          GROUP BY HQID)TableA
          END

          IF 'PRTR_By' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Trade Report By
          INSERT INTO @Temp
          SELECT
          HQID
          , 'PRTR_By'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(prtr_TradeReportId)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRTradeReport WITH (NOLOCK) ON prtr_ResponderId = comp_CompanyID
            AND prtr_Date BETWEEN @StartDate AND @EndDate
            AND prtr_Duplicate IS NULL
          INNER JOIN Company C1 WITH (NOLOCK) ON C1.Comp_CompanyId = prtr_SubjectId AND C1.comp_PRIgnoreTES IS NULL
          GROUP BY HQID)TableA
          END

          IF 'Bad_PRTR_By' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Neg Trade Report By
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Bad_PRTR_By'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = COUNT(prtr_TradeReportId)
          FROM @Population
          INNER JOIN Company WITH (NOLOCK) ON comp_PRHQId = HQID
          INNER JOIN PRTradeReport WITH (NOLOCK) ON prtr_ResponderId = comp_CompanyID
            AND prtr_Date BETWEEN @StartDate AND @EndDate
            AND prtr_Duplicate IS NULL
            AND (prtr_PayRatingId IN (2, 3, 4)
            OR prtr_IntegrityId IN (1,2))
          INNER JOIN Company C1 WITH (NOLOCK) ON C1.Comp_CompanyId = prtr_SubjectId AND C1.comp_PRIgnoreTES IS NULL
          GROUP BY HQID)TableA
          END

          IF 'Pay' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Pay Rating
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Pay'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = prpy_Weight
          FROM @Population
          INNER JOIN PRRating ON prra_CompanyId = HQID
          AND prra_Current = 'Y'
          INNER JOIN PRPayRating ON prra_PayRatingId = prpy_PayRatingId
          AND prpy_IsNumeral IS NULL)TableA
          END

          IF 'Integrity' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Integrity Rating
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Integrity'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,Cnt = prin_Weight
          FROM @Population
          INNER JOIN PRRating ON prra_CompanyId = HQID
          AND prra_Current = 'Y'
          INNER JOIN PRIntegrityRating ON prra_IntegrityId = prin_IntegrityRatingId
          AND prin_IsNumeral IS NULL)TableA
          END

          IF 'Revenue' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --Revenue
          INSERT INTO @Temp
          SELECT
          HQID
          , 'Revenue'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          , Cnt = SUM(prsp_ReceivedAmount)
          FROM PRServicePayment WITH (NOLOCK)
          INNER JOIN PRService WITH (NOLOCK) ON prse_ServiceId = prsp_ServiceId
          INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prse_CompanyId
          INNER JOIN @Population ON HQID = comp_PRHQId
          WHERE prsp_Activity = 'P'
          AND prsp_TransactionDate BETWEEN @StartDate AND @EndDate
          GROUP BY HQID)TablaA
          END

          IF 'DL' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
          --DL Line Count
          INSERT INTO @Temp
          SELECT
          HQID
          , 'DL'
          , Cnt
          , NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
          FROM(
          SELECT
          HQID
          ,cnt = SUM(dbo.ufn_GetListingDLLineCount(comp_CompanyID))
          FROM Company
          INNER JOIN @Population ON comp_PRHQId = HQID
          WHERE comp_PRListingStatus IN ('L','H')
          GROUP BY HQID)TableA
          WHERE cnt &gt; 0
END

--BBOS User Count
IF 'BBOS_User' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @Temp
	SELECT
		HQID
		, 'BBOS_User'
		, Cnt
		, NTILE(@TileCount) OVER(Order BY Cnt ASC, HQID DESC)
	FROM(
		SELECT
		 HQID
		 , Cnt = COUNT(prwu_WebUserID)
		FROM PRWebUser WITH (NOLOCK)
		INNER JOIN @Population ON HQID = prwu_HQID
		WHERE prwu_AccessLevel &gt; 10
		GROUP BY HQID)TablaA
END


IF 'TES_Respondent' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @TES
SELECT comp_PRHQId, 'Respondent', COUNT(prtesr_TESRequestID)
FROM PRTESRequest WITH (NOLOCK)
INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtesr_ResponderCompanyID
--INNER JOIN @Population ON comp_PRHQId = HQID
WHERE prtesr_CreatedDate BETWEEN @StartDate AND @EndDate
	AND comp_PRHQId IN (SELECT HQID FROM @Population)
GROUP BY comp_PRHQId

INSERT INTO @TES
SELECT comp_PRHQId, 'Respondent', COUNT(prtesr_TESRequestID)
FROM CRMArchive.dbo.PRTESRequest WITH (NOLOCK)
INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtesr_ResponderCompanyID
--INNER JOIN @Population ON comp_PRHQId = HQID
WHERE prtesr_CreatedDate BETWEEN @StartDate AND @EndDate
	AND comp_PRHQId IN (SELECT HQID FROM @Population)
GROUP BY comp_PRHQId
END

IF 'TES_Subject' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @TES
SELECT comp_PRHQId, 'Subject', COUNT(prtesr_TESRequestID)
FROM PRTESRequest WITH (NOLOCK)
INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtesr_SubjectCompanyID
--INNER JOIN @Population ON comp_PRHQId = HQID
WHERE prtesr_CreatedDate BETWEEN @StartDate AND @EndDate
	--and comp_PRHQId in (Select HQID from @Population)
GROUP BY comp_PRHQId

INSERT INTO @TES
SELECT comp_PRHQId, 'Subject', COUNT(prtesr_TESRequestID)
FROM CRMArchive.dbo.PRTESRequest WITH (NOLOCK)
INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtesr_SubjectCompanyID
--INNER JOIN @Population ON comp_PRHQId = HQID
WHERE prtesr_CreatedDate BETWEEN @StartDate AND @EndDate
	--and comp_PRHQId in (Select HQID from @Population)
GROUP BY comp_PRHQId
END

IF 'TES_Respondent' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
-- TES Sent
INSERT INTO @Temp
	SELECT
		CompanyID
		, 'TES_Respondent'
		, Cnt
		, NTILE(@TileCount) OVER(Order BY Cnt ASC, CompanyID DESC)
	FROM(
		SELECT
			CompanyID
			,Cnt = SUM(Cnt)
		FROM @TES
		INNER JOIN @Population ON HQID = CompanyID
		WHERE TESRole = 'Respondent'
		GROUP BY CompanyID )TableA	
END

IF 'TES_Subject' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
-- TES Sent
INSERT INTO @Temp
	SELECT
		CompanyID
		, 'TES_Subject'
		, Cnt
		, NTILE(@TileCount) OVER(Order BY Cnt ASC, CompanyID DESC)
	FROM(
		SELECT
			CompanyID
			,Cnt = SUM(Cnt)
		FROM @TES
		INNER JOIN @Population ON HQID = CompanyID
		WHERE TESRole = 'Subject'
		GROUP BY CompanyID )TableA
END


DECLARE @Comm TABLE (BBID INT, CommType NVARCHAR(10), Cnt INT)

IF 'Trx' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @Comm
	SELECT comp_PRHQId, 'Trx', COUNT(1)
	FROM PRTransaction WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtx_CompanyId
	WHERE prtx_CreatedDate BETWEEN @StartDate AND @EndDate
		AND comp_PRHQId IN (SELECT HQID FROM @Population)
	GROUP BY comp_PRHQId

INSERT INTO @Comm
	SELECT comp_PRHQId, 'Trx', COUNT(1)
	FROM crmarchive.dbo.PRTransaction WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prtx_CompanyId
	WHERE prtx_CreatedDate BETWEEN @StartDate AND @EndDate
		AND comp_PRHQId IN (SELECT HQID FROM @Population)
	GROUP BY comp_PRHQId
END

IF 'Int_Count' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @Comm
	SELECT comp_PRHQId, 'Int', COUNT(1)
	FROM Comm_Link WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = CmLi_Comm_CompanyID
	WHERE CmLi_CreatedDate BETWEEN @StartDate AND @EndDate
		AND comp_PRHQId IN (SELECT HQID FROM @Population)
	GROUP BY comp_PRHQId

INSERT INTO @Comm
	SELECT comp_PRHQId, 'Int', COUNT(1)
	FROM crmarchive.dbo.Comm_Link WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = CmLi_Comm_CompanyID
	WHERE CmLi_CreatedDate BETWEEN @StartDate AND @EndDate
		AND comp_PRHQId IN (SELECT HQID FROM @Population)
	GROUP BY comp_PRHQId
END

IF 'Trx' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @Temp
	SELECT
		BBID
		, 'Trx'
		, Cnt
		, NTILE(@TileCount) OVER(Order BY Cnt ASC, BBID DESC)
	FROM(
		SELECT
			BBID
			,Cnt = SUM(Cnt)
		FROM @Comm
		INNER JOIN @Population ON HQID = BBID
		WHERE CommType = 'Trx'
		GROUP BY BBID )TableA
END

IF 'Int_Count' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors)    BEGIN
INSERT INTO @Temp
	SELECT
		BBID
		, 'Int_Count'
		, Cnt
		, NTILE(@TileCount) OVER(Order BY Cnt ASC, BBID DESC)
	FROM(
		SELECT
			BBID
			,Cnt = SUM(Cnt)
		FROM @Comm
		INNER JOIN @Population ON HQID = BBID
		WHERE CommType = 'Int'
		GROUP BY BBID )TableA
END

IF 'Active_BBOS_User' IN (@ChosenFactors) OR 'BBOS_Pages_Viewed' IN (@ChosenFactors)    
	OR 'ALL' IN (@ChosenFactors) BEGIN
	DECLARE @BBOS TABLE (HQ INT, WebUserID INT, PgCnt INT)

	INSERT INTO @BBOS
	SELECT  
		HQID = comp_PRHQId
		, prwsat_WebUserID
		, COUNT(1)
	FROM PRWebAuditTrail WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prwsat_CompanyID
	INNER JOIN @Population ON HQID = comp_PRHQId
	WHERE prwsat_CreatedDate BETWEEN @StartDate AND @EndDate
	GROUP BY comp_PRHQId, prwsat_WebUserID

	INSERT INTO @BBOS
	SELECT  
		HQID = comp_PRHQId
		, prwsat_WebUserID
		, COUNT(1)
	FROM crmarchive.dbo.PRWebAuditTrail WITH (NOLOCK)
	INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prwsat_CompanyID
	INNER JOIN @Population ON HQID = comp_PRHQId
	WHERE prwsat_CreatedDate BETWEEN @StartDate AND @EndDate
	GROUP BY comp_PRHQId, prwsat_WebUserID
	
		IF 'Active_BBOS_User' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors) BEGIN
			INSERT INTO @Temp
				SELECT
					HQ
					, 'Active_BBOS_User'
					, Cnt
					, NTILE(@TileCount) OVER(Order BY Cnt ASC, HQ DESC)
				FROM(
					SELECT
						HQ
						,Cnt = COUNT(DISTINCT WebUserID)
					FROM @BBOS
					--INNER JOIN @Population ON HQID = HQ
					GROUP BY HQ)TableA
		END
		
		IF 'BBOS_Pages_Viewed' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors) BEGIN
			INSERT INTO @Temp
				SELECT
					HQ
					, 'BBOS_Pages_Viewed'
					, Cnt
					, NTILE(@TileCount) OVER(Order BY Cnt ASC, HQ DESC)
				FROM(
					SELECT
						HQ
						,Cnt = SUM(pgCnt)
					FROM @BBOS
					--INNER JOIN @Population ON HQID = HQ
					GROUP BY HQ)TableA
		END
END

IF 'BBOS_Viewers' IN (@ChosenFactors) OR 'ALL' IN (@ChosenFactors) BEGIN


		DECLARE @BBOSViews TABLE (HQ INT, WebUserID INT, PgCnt INT)
		INSERT INTO @BBOSViews
		SELECT
			HQ = comp_PRHQId
			, Viewer = prwsat_CreatedBy
			, COUNT(1)
		FROM PRWebAuditTrail WITH (NOLOCK)
		INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prwsat_AssociatedID
		INNER JOIN @Population ON HQID = comp_PRHQId
		WHERE prwsat_CreatedDate BETWEEN @StartDate AND @EndDate
		AND prwsat_AssociatedType = 'C'
		GROUP BY comp_PRHQId, prwsat_CreatedBy

		INSERT INTO @BBOSViews
		SELECT
			HQ = comp_PRHQId
			, Viewer = prwsat_CreatedBy
			, COUNT(1)
		FROM crmarchive.dbo.PRWebAuditTrail WITH (NOLOCK)
		INNER JOIN Company WITH (NOLOCK) ON comp_CompanyID = prwsat_AssociatedID
		INNER JOIN @Population ON HQID = comp_PRHQId
		WHERE prwsat_CreatedDate BETWEEN @StartDate AND @EndDate
		AND prwsat_AssociatedType = 'C'
		GROUP BY comp_PRHQId, prwsat_CreatedBy

	INSERT INTO @Temp
				SELECT
					HQ
					, 'BBOS_Viewers'
					, Cnt
					, NTILE(@TileCount) OVER(Order BY Cnt ASC, HQ DESC)
				FROM(
					SELECT
						HQ
						,Cnt = COUNT(DISTINCT WebUserID)
					FROM @BBOS
					--INNER JOIN @Population ON HQID = HQ
					GROUP BY HQ)TableA
END



IF @RequireFactors = 1 BEGIN
	DELETE FROM @Population
	WHERE HQID NOT IN (SELECT BBID FROM @Temp WHERE Factor IN (@MustHaves))
END

DECLARE @DataFields TABLE (
		BBID INT
		,  company_name NVARCHAR(1500)
		,  Listing_Status NVARCHAR(1500)
		,  Book_Section NVARCHAR(1500)
		,  Type NVARCHAR(1500)
		,  Listing_City NVARCHAR(1500)
		,  Listing_State NVARCHAR(1500)
		,  Listing_Country NVARCHAR(1500)
		,  Sales_Terr NVARCHAR(1500)
		,  TM_Status NVARCHAR(1500)
		,  TM_Award_Date NVARCHAR(1500)
		,  TM_Age NVARCHAR(1500)
		,  Business_Start NVARCHAR(1500)
		,  Years_in_Business NVARCHAR(1500)
		,  Attn_Line NVARCHAR(1500)
		,  Addr_Line_1 NVARCHAR(1500)
		,  Addr_Line_2 NVARCHAR(1500)
		,  Addr_Line_3 NVARCHAR(1500)
		,  City NVARCHAR(1500)
		,  Abbr NVARCHAR(1500)
		,  Zip NVARCHAR(1500)
		,  Phone NVARCHAR(1500)
		,  Fax NVARCHAR(1500)
		,  Email NVARCHAR(1500)
		,  Website NVARCHAR(1500)
		,  Prime_Service NVARCHAR(1500)
		,  CWE NVARCHAR(1500)
		,  Int_Rating NVARCHAR(1500)
		,  Pay_Rating NVARCHAR(1500)
		,  Current_Numerals NVARCHAR(1500)
		,  Rating_Line NVARCHAR(1500)
		,  Classification_Line NVARCHAR(1500)
		,  Level_1_Classification NVARCHAR(1500)
		,  Commodity_Line NVARCHAR(1500)
		,  DL_Line_Count NVARCHAR(1500)
		,  Has_Logo NVARCHAR(1500)
		,  Advertiser NVARCHAR(1500)
		,  Promo_Opt_Out NVARCHAR(1500))

INSERT INTO @DataFields
	SELECT * FROM vPRSalesRetrievals
		WHERE BBID IN (SELECT HQID FROM @Population)

Declare @Labels Table (ColName nvarchar(1000), DisplayName nvarchar(1000), ord int)

Insert Into @Labels (ColName,DisplayName,Ord) Values ('company_name','Name',1000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Book_Section','Ind',2000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Listing_City','Listing City',3000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Listing_State','Listing State',4000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Listing_Country','Listing Country',5000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Sales_Terr','Terr',6000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Prime_Service','Primary Service',7000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Email','Email',7500);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Phone','Phone',7600);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Fax','Fax',7700);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Website','Website',7900);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('TM_Status','TM',8000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Rating_Line','Rating Line',9000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('CWE_Value','CWE',9100);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Integrity_Value','Integrity Rating',9200);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Pay_Value','Pay Rating',9300);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Volume_Value','Volume',9600);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Has_Logo','Logo',10000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Advertiser','Advertiser',11000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Promo_Opt_Out','Promo Opt Out',12000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Person_Value','Personnel Count',13000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Locations_Value','Num Locations',14000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Int_Count_Value','Interaction count',15000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Trx_Value','Transaction Count',16000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Revenue_Value','Revenue',17000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('CSItem_Value','CS Item Count',18000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Connections_Value','Num Connections',19000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Xconnections_Value','Cross Connection Count',20000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Active_BBOS_User_Value','Active BBOS Users',21000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('BBOS_User_Value','BBOS Users Assigned',22000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('BBOS_Pages_Viewed_Value','BBOS Pages Viewed By',23000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('BBOS_Viewers_Value','BBOS Views',24000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Years_in_Business','Business Age',25000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Business_Start','Business Start',26000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Level_1_Classification','Level 1 Classifications',26500);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Classification_Line','Classifications',27000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Commodity_Line','Commodities',28000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('DL_Value','DL Count',29000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Bad_PRTR_By_Value','Neg Trade Reports',30000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('TES_Respondent_Value','TES Request Count',31000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('TES_Subject_Value','TES Sent About Count',32000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('PRTR_By_Value','Trade Report By Count',33000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('PRTR_On_Value','Trade Reports On Count',34000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('TM_Age','TM Age',35000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('TM_Award_Date','TM Date',36000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Type','Type',37000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Listing_Status','Listing Status',38000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Addr_Line_1','Addr 1',39000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Addr_Line_2','Addr 2',40000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Addr_Line_3','Addr 3',41000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('City','Addr City',42000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Abbr','Addr State',43000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Zip','Addr Zip',44000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Attn_Line','Attn Line',45000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Points_Earned','Points Earned',999000);
Insert Into @Labels (ColName,DisplayName,Ord) Values ('Possible_Points','Possible Points',999000);




                      
INSERT INTO #DisplayValues
SELECT BBID, ColumnName, ColumnValue
FROM 
   (SELECT *
   FROM @DataFields) p
UNPIVOT
   (ColumnValue FOR ColumnName IN 
      (company_name
		,  Listing_Status
		,  Book_Section
		,  [Type]
		,  Listing_City
		,  Listing_State
		,  Listing_Country
		,  Sales_Terr
		,  TM_Status
		,  TM_Award_Date
		,  TM_Age
		,  Business_Start
		,  Years_in_Business
		,  Attn_Line
		,  Addr_Line_1
		,  Addr_Line_2
		,  Addr_Line_3
		,  City
		,  Abbr
		,  Zip
		,  Phone
		,  Fax
		,  Email
		,  Website
		,  Prime_Service
		,  Rating_Line
		,  Classification_Line
		,  Level_1_Classification
		,  Commodity_Line
		,  Has_Logo
		,  Advertiser
		,  Promo_Opt_Out)
)AS unpvt;


INSERT INTO #DisplayValues
	SELECT BBID, Factor + '_Value', Val
	FROM @Temp
	inner join @Population on HQID = BBID
	Order BY Factor

INSERT INTO #DisplayValues
	SELECT HQID, 'Possible_Points', COUNT(factor) * @TileCount
	FROM @Population
	INNER JOIN @Temp ON BBID = HQID
	GROUP BY HQID

INSERT INTO #DisplayValues
	SELECT HQID, 'Points_Earned', SUM(tile)
	FROM @Population
	INNER JOIN @Temp ON BBID = HQID
	GROUP BY HQID

SELECT nxd, BBID, d.ColName,DisplayName, ColValue
FROM #DisplayValues d
left outer join @Labels l on l.ColName = d.ColName
Order BY ord
 
DROP TABLE #DisplayValues</CommandText>
        <rd:UseGenericDesigner>true</rd:UseGenericDesigner>
      </Query>
      <Fields>
        <Field Name="nxd">
          <DataField>nxd</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="BBID">
          <DataField>BBID</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="ColName">
          <DataField>ColName</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="DisplayName">
          <DataField>DisplayName</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="ColValue">
          <DataField>ColValue</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="FactorsList">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <CommandText>DECLARE @Factors TABLE (FactorLabel nvarchar(200), FactorName nvarchar(200));

Insert Into @Factors (FactorLabel,FactorName) Values ('Person Count','Person');
Insert Into @Factors (FactorLabel,FactorName) Values ('Connection Count','Connections');
Insert Into @Factors (FactorLabel,FactorName) Values ('Cross Connection Count','Xconnections');
Insert Into @Factors (FactorLabel,FactorName) Values ('Credit Worth','CWE');
Insert Into @Factors (FactorLabel,FactorName) Values ('Volume','Volume');
Insert Into @Factors (FactorLabel,FactorName) Values ('Location Count','Locations');
Insert Into @Factors (FactorLabel,FactorName) Values ('CS Item Count','CSItem');
Insert Into @Factors (FactorLabel,FactorName) Values ('Trade Report On','PRTR_On');
Insert Into @Factors (FactorLabel,FactorName) Values ('Trade Report By','PRTR_By');
Insert Into @Factors (FactorLabel,FactorName) Values ('Negative Trade Report By','Bad_PRTR_By');
Insert Into @Factors (FactorLabel,FactorName) Values ('Pay Rating','Pay');
Insert Into @Factors (FactorLabel,FactorName) Values ('Integrity Rating','Integrity');
Insert Into @Factors (FactorLabel,FactorName) Values ('BBSI Revenue','Revenue');
Insert Into @Factors (FactorLabel,FactorName) Values ('DL Line Count','DL');
Insert Into @Factors (FactorLabel,FactorName) Values ('BBOS User Count','BBOS_User');
Insert Into @Factors (FactorLabel,FactorName) Values ('TES Sent To','TES_Respondent');
Insert Into @Factors (FactorLabel,FactorName) Values ('TES Sent About','TES_Subject');
Insert Into @Factors (FactorLabel,FactorName) Values ('Transaction Count','Trx');
Insert Into @Factors (FactorLabel,FactorName) Values ('Interaction Count','Int_Count');
Insert Into @Factors (FactorLabel,FactorName) Values ('Active BBOS User Count','Active_BBOS_User');
Insert Into @Factors (FactorLabel,FactorName) Values ('BBOS Usage Count','BBOS_Pages_Viewed');
Insert Into @Factors (FactorLabel,FactorName) Values ('BBOS Viewers','BBOS_Viewers');

Select * from @Factors</CommandText>
      </Query>
      <Fields>
        <Field Name="FactorLabel">
          <DataField>FactorLabel</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="FactorName">
          <DataField>FactorName</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="Ind">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <CommandText>SELECT 
	'Ind' = Capt_Code
	, 'Name' = RTRIM(CONVERT(NVARCHAR(50),Capt_US))
FROM Custom_Captions WITH (NOLOCK)
WHERE Capt_Family = 'comp_PRIndustryType'
Order BY Capt_Order</CommandText>
      </Query>
      <Fields>
        <Field Name="Ind">
          <DataField>Ind</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="Name">
          <DataField>Name</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="Territory">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <CommandText>
SELECT DISTINCT 'Territory' = LEFT(prci_SalesTerritory,2)
FROM PRCity WITH (NOLOCK)
WHERE prci_SalesTerritory IS NOT NULL
Order BY Territory</CommandText>
      </Query>
      <Fields>
        <Field Name="Territory">
          <DataField>Territory</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="MemType">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <CommandText>SELECT        prod_code AS 'Value', prod_code AS Name
FROM            NewProduct WITH (NOLOCK)
WHERE        (prod_productfamilyid = 5) AND (prod_Active = 'Y')
UNION
SELECT        'None' AS Expr1, 'None' AS Expr2</CommandText>
      </Query>
      <Fields>
        <Field Name="Value">
          <DataField>Value</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="Name">
          <DataField>Name</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="States">
      <Query>
        <DataSourceName>BBS</DataSourceName>
        <CommandText>SELECT
	'StateID' = prst_StateID
	, 'DisplayValue' = CASE
		WHEN prst_State IS NOT NULL THEN prst_State + ',' + prcn_Country
		ELSE prcn_Country
		END
	, 'Ord' = CASE WHEN prcn_CountryId &lt; 4 THEN prcn_CountryId
		ELSE 99 END
FROM PRState WITH (NOLOCK)
INNER JOIN PRCountry WITH (NOLOCK) ON prst_CountryId = prcn_CountryId
WHERE prcn_CountryId &gt; 0
Order BY Ord, prcn_Country, prst_State</CommandText>
      </Query>
      <Fields>
        <Field Name="StateID">
          <DataField>StateID</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="DisplayValue">
          <DataField>DisplayValue</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="Ord">
          <DataField>Ord</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <ReportParameters>
    <ReportParameter Name="StartDate">
      <DataType>DateTime</DataType>
      <Prompt>Start Date</Prompt>
    </ReportParameter>
    <ReportParameter Name="EndDate">
      <DataType>DateTime</DataType>
      <Prompt>End Date</Prompt>
    </ReportParameter>
    <ReportParameter Name="TileCount">
      <DataType>Integer</DataType>
      <Prompt>Number of Segments</Prompt>
    </ReportParameter>
    <ReportParameter Name="Ind">
      <DataType>String</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>Ind</DataSetName>
          <ValueField>Name</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>Ind</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>Ind</DataSetName>
          <ValueField>Ind</ValueField>
          <LabelField>Name</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
    <ReportParameter Name="State">
      <DataType>Integer</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>States</DataSetName>
          <ValueField>StateID</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>State</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>States</DataSetName>
          <ValueField>StateID</ValueField>
          <LabelField>DisplayValue</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
    <ReportParameter Name="Territory">
      <DataType>String</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>Territory</DataSetName>
          <ValueField>Territory</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>Territory</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>Territory</DataSetName>
          <ValueField>Territory</ValueField>
          <LabelField>Territory</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
    <ReportParameter Name="MemType">
      <DataType>String</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>MemType</DataSetName>
          <ValueField>Value</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>Membership Type</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>MemType</DataSetName>
          <ValueField>Value</ValueField>
          <LabelField>Name</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
    <ReportParameter Name="ChosenFactors">
      <DataType>String</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>FactorsList</DataSetName>
          <ValueField>FactorName</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>Include These Factors</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>FactorsList</DataSetName>
          <ValueField>FactorName</ValueField>
          <LabelField>FactorLabel</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
    <ReportParameter Name="RequireFactors">
      <DataType>Boolean</DataType>
      <DefaultValue>
        <Values>
          <Value>false</Value>
        </Values>
      </DefaultValue>
      <Prompt>Require Factors</Prompt>
    </ReportParameter>
    <ReportParameter Name="MustHaves">
      <DataType>String</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>FactorsList</DataSetName>
          <ValueField>FactorName</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Prompt>Must Have These Factors</Prompt>
      <ValidValues>
        <DataSetReference>
          <DataSetName>FactorsList</DataSetName>
          <ValueField>FactorName</ValueField>
          <LabelField>FactorLabel</LabelField>
        </DataSetReference>
      </ValidValues>
      <MultiValue>true</MultiValue>
    </ReportParameter>
  </ReportParameters>
  <Language>en-US</Language>
  <ConsumeContainerWhitespace>true</ConsumeContainerWhitespace>
  <rd:ReportUnitType>Inch</rd:ReportUnitType>
  <rd:ReportID>cd99bee6-c456-4313-9692-6b8b2f9719d9</rd:ReportID>
</Report>