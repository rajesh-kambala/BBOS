INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (204482, 'GetAds', 'LH204482Test', 'localhost', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (204482, 'GetAds', 'QA204482Test', 'qa.apps.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'PRD100002Test', 'apps.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'QA100002Test', 'qa.apps.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'WP100002Test', 'qa.produce.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'LH100002Test', 'localhost', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'WP100002Test', 'qa.produce.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());


INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'BBSIProduceAds', 'www.producebluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'BBSILumberAds', 'www.lumberbluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'WP100002Test', 'qa.produce.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'WP100002LumberTest', 'qa.lumber.bluebookservices.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'BBSIProduceQF', 'www.producebluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'BBSILumberQF', 'www.lumberbluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());



INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'BBSIProduceAdsBeta', 'beta.producebluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'GetAds', 'BBSILumberAdsBeta', 'beta.lumberbluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'BBSIProduceQFBeta', 'beta.producebluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());

INSERT INTO PRWidgetKey (prwk_CompanyID, prwk_WidgetTypeCode, prwk_LicenseKey, prwk_HostName, prwk_CreatedBy, prwk_CreatedDate, prwk_UpdatedBy, prwk_UpdatedDate, prwk_TimeStamp)
VALUES (100002, 'QuickFind', 'BBSILumberQFBeta', 'beta.lumberbluebook.com', -1, GETDATE(), -1, GETDATE(), GETDATE());
Go

--UPDATE PRWidgetKey SET prwk_HostName = 'qa.produce.bluebookservices.com' WHERE prwk_HostName = 'qa.wordpress.bluebookservices.com'

DECLARE @AdEligiblePageID int

/*
DELETE FROM PRAdEligiblePage WHERE pradep_PageName = 'ProduceMarketingSite';

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA', 'Produce Marketing Site', 'ProduceMarketingSite')
*/

SET @AdEligiblePageID = 6006
UPDATE PRAdEligiblePage
   SET pradep_DisplayName = 'Produce Marketing Site',
       pradep_PageName = 'ProduceMarketingSite'
 WHERE pradep_AdEligiblePageID = 6006;

DELETE FROM PRAdEligiblePage WHERE pradep_PageName = 'ProduceMarketingSite' AND pradep_AdCampaignType IN ('IA_960x100', 'IA_180x570', 'IA_180x90');

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_960x100', 'Produce Marketing Site', 'ProduceMarketingSite')

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_180x570', 'Produce Marketing Site', 'ProduceMarketingSite')

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_180x90', 'Produce Marketing Site', 'ProduceMarketingSite')






DELETE FROM PRAdEligiblePage WHERE pradep_PageName = 'LumberMarketingSite';

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA', 'Lumber Marketing Site', 'LumberMarketingSite')

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_960x100', 'Lumber Marketing Site', 'LumberMarketingSite')

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_180x570', 'Lumber Marketing Site', 'LumberMarketingSite')

EXEC usp_GetNextId 'PRAdEligiblePage', @AdEligiblePageID output
INSERT INTO PRAdEligiblePage (pradep_AdEligiblePageID, pradep_AdCampaignType, pradep_DisplayName, pradep_PageName)
VALUES (@AdEligiblePageID, 'IA_180x90', 'Lumber Marketing Site', 'LumberMarketingSite')
Go


UPDATE PRAdEligiblePage
   SET pradep_MarketingPage = 'Y'
 WHERE pradep_PageName IN ('IndustryLinks', 'ProduceMarketingSite', 'LumberMarketingSite');
Go


/*
DECLARE @AdEligiblePageID int, @AdCampaignID int, @AdCampaignPageID int, @Count int = 0, @Index int = 0

SELECT @AdEligiblePageID = pradep_AdEligiblePageID
  FROM PRAdEligiblePage
 WHERE pradep_AdCampaignType = 'IA'
   AND pradep_PageName = 'ProduceMarketingSite'


DECLARE @MyTable table (
	ndx int identity(1, 1),
	AdCampaignID int
)

INSERT INTO @MyTable (AdCampaignID)
SELECT pradc_AdCampaignID
  FROM PRAdCampaign
       INNER JOIN PRAdCampaignPage ON pradc_AdCampaignID = pradcp_AdCampaignID
       INNER JOIN PRAdEligiblePage ON pradcp_AdEligiblePageID = pradep_AdEligiblePageID
 WHERE pradc_AdCampaignType = 'IA'
   AND GETDATE() BETWEEN pradc_StartDate AND pradc_EndDate
   AND pradep_PageName = 'IndustryLinks'


SELECT @Count = COUNT(1) FROM @MyTable

WHILE @Index < @Count BEGIN

	SET @Index = @Index + 1
	SELECT @AdCampaignID = AdCampaignID
	  FROM @MyTable 
	 WHERE ndx = @Index;

	 EXEC usp_GetNextId 'PRAdCampaignPage', @AdCampaignPageID output

	 INSERT INTO PRAdCampaignPage (pradcp_AdCampaignPageID, pradcp_AdEligiblePageID, pradcp_AdCampaignID, pradcp_CreatedBy, pradcp_CreatedDate)
	 VALUES (@AdCampaignPageID, @AdEligiblePageID, @AdCampaignID, -1, GETDATE())
END
*/
Go



UPDATE NewProduct
   SET --prod_Name = 'Print Book Membership 100-p',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">An April and October print Blue Book</li><li class="bulletListItem">1 Limited BBOS user license</li><li class="bulletListItem">5 Business Reports </li></ul>',
	   prod_PRSequence = 10,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS100'

UPDATE NewProduct
   SET --prod_Name = 'Basic Online Membership 100-e',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">1 Limited BBOS user license</li><li class="bulletListItem">5 Business Reports</li></ul>',
	   prod_PRSequence = 20,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS100-E'

UPDATE NewProduct
   SET --prod_Name = 'Intermediate Online Membership 150',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">3 Intermediate BBOS user licenses</li><li class="bulletListItem">10 Business Reports</li></ul>',
	   prod_PRSequence = 30,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS150'

UPDATE NewProduct
   SET --prod_Name = 'Advanced Online Membership 200',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">5 Advanced BBOS user licenses</li><li class="bulletListItem">15 Business Reports</li></ul>',
	   prod_PRSequence = 40,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS200'

UPDATE NewProduct
   SET --prod_Name = 'Premium Online Membership 300',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">10 Premium BBOS user licenses</li><li class="bulletListItem">85 Business Reports</li></ul>',
	   prod_PRSequence = 50,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS300'

UPDATE NewProduct
   SET --prod_Name = 'Premium Online Membership 350',
       prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">20 Premium BBOS user licenses</li><li class="bulletListItem">120 Business Reports </li></ul>',
	   prod_PRSequence = 60,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'BBS350'


UPDATE NewProduct
   SET prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">3 BBOS user licenses</li><li class="bulletListItem">60 Business Reports</li></ul>',
	   prod_PRSequence = 10,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'L200'

UPDATE NewProduct
   SET prod_PRDescription = '<ul class="bulletList"><li class="bulletListItem">10 BBOS user licenses</li><li class="bulletListItem">120 Business Reports</li></ul>',
	   prod_PRSequence = 20,
	   prod_PurchaseInBBOS = 'Y'
WHERE prod_code = 'L225'

Go


UPDATE PRWebUser SET prwu_AcceptedTerms = NULL;
Go

UPDATE PRWebUser
   SET prwu_AccessLevel = '0',
       prwu_UpdatedBy = -1,
	   prwu_UpdatedDate = GETDATE(), 
	   prwu_PreviousAccessLevel = prwu_AccessLevel
WHERE prwu_AccessLevel IN ('10', '5')
Go

UPDATE NewProduct
   SET prod_PRDescription = 'Designed for buyers, sellers, transporters and suppliers who are seeking to perform a basic evaluation on a prospective or current trading partner.<p>The Level 1 Business Report includes: Blue Book ID#, company name, listing location, addresses, phones, faxes, e-mails, web URLs, commodities, company functions, annual volume and alternate trade names. Also included, if available/applicable, are current company rating & rating definition, principals & titles, affiliated businesses, branch locations, recent business developments, and business profile.',
       prod_IndustryTypeCode = ',P,',
	   prod_PurchaseInBBOS = 'Y'
 WHERE prod_code = 'BR1'
   AND prod_ProductFamilyID=3

UPDATE NewProduct
   SET prod_PRDescription = 'Designed for buyers, sellers, transporters and suppliers who want to perform financial analyis and recent trend analysis.<p>In addition to the details available in the Level 1 report, the Level 2 report shows the last 18 months of trade evaluations and rating history. Also included, if available/applicable, is the most recent financial statement figures.',
       prod_IndustryTypeCode = ',P,',
	   prod_PurchaseInBBOS = 'Y'
 WHERE prod_code = 'BR2'
   AND prod_ProductFamilyID=3

UPDATE NewProduct
   SET prod_PRDescription = 'Designed for sellers, transporters and suppliers who are seeking to perform a high-level evaluation on an account, with a specific interest in current and trend facts.<p>The Level 3 Business Report includes all the details available in the Level 1 & 2 reports. Also included, if available/applicable, are bankruptcy events, business background, personnel background, the last three financial statements provided, year-to-date trade report summary, previous two calendar years of trade reports, and trade report details for the past 18 months.  Rating information is provided in easy to interpret tables and graphs.',
       prod_IndustryTypeCode = ',P,',
	   prod_PurchaseInBBOS = 'Y'
 WHERE prod_code = 'BR3'
   AND prod_ProductFamilyID=3
Go



UPDATE PRMembershipPurchase
   SET prmp_IndustryType = CASE WHEN ISNULL(prod_IndustryTypeCode, 'x') = ',L,' THEN 'L' ELSE 'P' END
  FROM NewProduct
 WHERE prmp_ProductID = prod_ProductID
Go


INSERT INTO CRM.dbo.PRInvoiceTaxRate (pritr_CreatedDate, pritr_InvoiceNo, pritr_TaxClass, pritr_Group, pritr_ProductLine, pritr_InvoiceAmt, pritr_TaxRate, pritr_TaxAmt, pritr_County, pritr_City, pritr_State)
    SELECT InvoiceDate,
	       hdr.InvoiceNo,
	       det.TaxClass,
	       item.Category2,
	       prod.ProductLineDesc,
	       SUM(ExtensionAmt) as InvoiceAmt,
		   mtax.TaxRate,
		   SUM(ExtensionAmt) * (mtax.TaxRate/100) as TaxAmt,
		   tax.prtax_County,
 		   tax.prtax_City,
		   tax.prtax_State
	  FROM MAS_PRC.dbo.AR_InvoiceHistoryDetail det WITH (NOLOCK)
		   INNER JOIN MAS_PRC.dbo.CI_Item Item WITH (NOLOCK) ON item.ItemCode = det.ItemCode
		   INNER JOIN MAS_PRC.dbo.AR_InvoiceHistoryHeader hdr WITH (NOLOCK) ON hdr.InvoiceNo = det.InvoiceNo
		   INNER JOIN CRM.dbo.PRTaxRate tax WITH (NOLOCK) ON tax.prtax_TaxCode = hdr.TaxSchedule
		   INNER JOIN MAS_SYSTEM.dbo.SY_SalesTaxCodeDetail mtax WITH (NOLOCK) ON mtax.TaxCode = hdr.TaxSchedule
														AND mtax.TaxClass = det.TaxClass
           INNER JOIN MAS_PRC.dbo.IM_ProductLine prod WITH (NOLOCK) ON prod.ProductLine = item.ProductLine
     WHERE hdr.InvoiceType = 'CM'
	   AND hdr.InvoiceDate >= '2014-02-25'
	   AND hdr.InvoiceNo NOT IN (SELECT DISTINCT pritr_InvoiceNo FROM PRInvoiceTaxRate)
  GROUP BY InvoiceDate,
           hdr.InvoiceNo,
	       det.TaxClass,
		   item.Category2,
		   prod.ProductLineDesc,
		   mtax.TaxRate,
		   tax.prtax_County,
		   tax.prtax_City,
		   tax.prtax_State;
Go



	DELETE FROM WordPress.dbo.wp_posts
	 WHERE ID IN (SELECT post_id FROM WordPress.dbo.wp_postmeta WHERE meta_key = 'bbsi_crm' AND meta_value = 'true');

	DELETE FROM WordPress.dbo.wp_postmeta
	 WHERE post_id IN (SELECT post_id FROM WordPress.dbo.wp_postmeta WHERE meta_key = 'bbsi_crm' AND meta_value = 'true');


	INSERT INTO [WordPress].[dbo].wp_posts (post_author, post_date, post_date_gmt,  post_content, post_title, post_excerpt, post_status, comment_status, ping_status, 
											post_password, post_name, post_modified, post_modified_gmt, post_content_filtered, post_parent,
											menu_order, post_type, post_mime_type, comment_count, to_ping, pinged)
	SELECT post_author = [WordPress].[dbo].wp_users.ID, 
		   post_date = prpbar_PublishDate, 
		   post_date_gmt = DATEADD(hour, 6, prpbar_PublishDate), 
		   post_content = REPLACE(prpbar_Body, 'ExternalLink.aspx', CRM.dbo.ufn_GetCustomCaptionValue('BBOS', 'URL', 'en-us')  + 'ExternalLink.aspx'),  --prpbar_Body, 
		   post_title = prpbar_Name, 
		   post_excerpt = ISNULL(prpbar_Abstract, ''), 
		   post_status = 'publish',
		   comment_status = 'open',
		   ping_status = 'open',
		   post_password = '',
		   post_name = CRM.dbo.ufn_PreparePostName(prpbar_Name),
		   post_modified = prpbar_CreatedDate,
		   post_modified_gmt =  DATEADD(hour, 6, prpbar_CreatedDate),
		   post_content_filtered = '',
		   post_parent = 0,
		   menu_order = 0,
		   post_type = 'post',
		   post_mime_type = '', 
		   comment_count = 0,
		   to_ping = '',
		   pinged = ''
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN CRM.dbo.users ON i.prpbar_CreatedBy = user_userid
		   INNER JOIN [WordPress].[dbo].wp_users ON user_logon = user_login
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,P,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_postmeta (post_id, meta_key, meta_value)
	SELECT ID, 'bbsi_crm', 'true'
		FROM CRM.dbo.PRPublicationArticle i
			INNER JOIN WordPress.dbo.wp_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	  WHERE prpbar_PublicationCode = 'BBN'
		    AND prpbar_IndustryTypeCode LIKE '%,P,%'
		    AND prpbar_MembersOnly IS NULL
		    AND prpbar_PublishDate <= GETDATE()
		    AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_postmeta (post_id, meta_key, meta_value)
	SELECT ID, 'prpbar_PublicationArticleID', prpbar_PublicationArticleID
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	  WHERE prpbar_PublicationCode = 'BBN'
		    AND prpbar_IndustryTypeCode LIKE '%,P,%'
		    AND prpbar_MembersOnly IS NULL
		    AND prpbar_PublishDate <= GETDATE()
		    AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_term_relationships
	SELECT ID, 1, 0
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	  WHERE prpbar_PublicationCode = 'BBN'
		    AND prpbar_IndustryTypeCode LIKE '%,P,%'
		    AND prpbar_MembersOnly IS NULL
		    AND prpbar_PublishDate <= GETDATE()
		    AND prpbar_ExpirationDate > GETDATE()

	UPDATE [WordPress].[dbo].wp_posts
	   SET guid = 'http://qa.produce.bluebookservices.com/?p=' + CAST(id as varchar(10))
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	  WHERE prpbar_PublicationCode = 'BBN'
		    AND prpbar_IndustryTypeCode LIKE '%,P,%'
		    AND prpbar_MembersOnly IS NULL
		    AND prpbar_PublishDate <= GETDATE()
		    AND prpbar_ExpirationDate > GETDATE()
Go






	DELETE FROM WordPress.dbo.wp_2_posts
	 WHERE ID IN (SELECT post_id FROM WordPress.dbo.wp_2_postmeta WHERE meta_key = 'bbsi_crm' AND meta_value = 'true');

	DELETE FROM WordPress.dbo.wp_2_postmeta
	 WHERE post_id IN (SELECT post_id FROM WordPress.dbo.wp_2_postmeta WHERE meta_key = 'bbsi_crm' AND meta_value = 'true');


	INSERT INTO [WordPress].[dbo].wp_2_posts (post_author, post_date, post_date_gmt,  post_content, post_title, post_excerpt, post_status, comment_status, ping_status, 
											post_password, post_name, post_modified, post_modified_gmt, post_content_filtered, post_parent,
											menu_order, post_type, post_mime_type, comment_count, to_ping, pinged)
	SELECT post_author = [WordPress].[dbo].wp_users.ID, 
		   post_date = prpbar_PublishDate, 
		   post_date_gmt = DATEADD(hour, 6, prpbar_PublishDate), 
		   post_content = REPLACE(prpbar_Body, 'ExternalLink.aspx', CRM.dbo.ufn_GetCustomCaptionValue('BBOS', 'URL', 'en-us')  + 'ExternalLink.aspx'),  --prpbar_Body, 
		   post_title = prpbar_Name, 
		   post_excerpt = ISNULL(prpbar_Abstract, ''), 
		   post_status = 'publish',
		   comment_status = 'open',
		   ping_status = 'open',
		   post_password = '',
		   post_name = CRM.dbo.ufn_PreparePostName(prpbar_Name),
		   post_modified = prpbar_CreatedDate,
		   post_modified_gmt =  DATEADD(hour, 6, prpbar_CreatedDate),
		   post_content_filtered = '',
		   post_parent = 0,
		   menu_order = 0,
		   post_type = 'post',
		   post_mime_type = '', 
		   comment_count = 0,
		   to_ping = '',
		   pinged = ''
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN CRM.dbo.users ON i.prpbar_CreatedBy = user_userid
		   INNER JOIN [WordPress].[dbo].wp_users ON user_logon = user_login
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,L,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_2_postmeta (post_id, meta_key, meta_value)
	SELECT ID, 'bbsi_crm', 'true'
		FROM CRM.dbo.PRPublicationArticle i
			INNER JOIN WordPress.dbo.wp_2_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,L,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_2_postmeta (post_id, meta_key, meta_value)
	SELECT ID, 'prpbar_PublicationArticleID', prpbar_PublicationArticleID
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_2_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,L,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()

	INSERT INTO WordPress.dbo.wp_2_term_relationships
	SELECT ID, 1, 0
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_2_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,L,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()

	UPDATE [WordPress].[dbo].wp_2_posts
	   SET guid = 'http://qa.lumber.bluebookservices.com/?p=' + CAST(id as varchar(10))
	  FROM CRM.dbo.PRPublicationArticle i
		   INNER JOIN WordPress.dbo.wp_2_posts ON prpbar_Name = post_title AND prpbar_PublishDate = post_date
	 WHERE prpbar_PublicationCode = 'BBN'
	   AND prpbar_IndustryTypeCode LIKE '%,L,%'
	   AND prpbar_MembersOnly IS NULL
	   AND prpbar_PublishDate <= GETDATE()
	   AND prpbar_ExpirationDate > GETDATE()
Go


UPDATE Company
   SET comp_PRServiceEndDate = CancelDate
 FROM (SELECT comp_CompanyID, comp_PRServiceStartDate, comp_PRServiceEndDate, CancelDate
	  FROM Company
		   INNER JOIN (SELECT prsoat_SoldToCompany, MAX(prsoat_CreatedDate) as CancelDate 
						 FROM PRSalesOrderAuditTrail 
						WHERE prsoat_ActionCode = 'C' GROUP BY prsoat_SoldToCompany) T1 ON comp_CompanyID = prsoat_SoldToCompany
	 WHERE comp_PRServiceStartDate IS NOT NULL
	   AND comp_PRServiceEndDate IS NULL
	   AND comp_CompanyID NOT IN (SELECT prse_CompanyID FROM PRService WHERE prse_Primary = 'Y')
	   --AND comp_CompanyID IN (SELECT prsoat_SoldToCompany FROM PRSalesOrderAuditTrail WHERE prsoat_ActionCode = 'C')
	   AND comp_PRServiceStartDate < CancelDate) T1
WHERE Company.comp_CompanyID = T1.comp_CompanyID
Go